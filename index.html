<!DOCTYPE html>
<html lang="en">

<head>
	<link href="https://fonts.googleapis.com/css?family=Abel&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="style.css">

    <title>Age of Sigmulator</title>
</head>

<body bgcolor='#35342F' text='#FEF7DB'>
    <!--name-->
    <div><font size="6">Age of Sigmulator</font></div>
    <br />
	
	<!------------->
	<!--         -->
    <!-- WEAPONS -->
	<!--         -->
	<!------------->
	<div id='WEAPONS'>
		<div><font size="4"><i>Weapons</i></font></div>
        
        <table type='profilesTable' id='profileParent'>
			<tr id='kingsRow'>
				<td type='profilesTd'>
					<div id='weaponContainer' type='weaponContainer'>
						<table id='weapon1' type='modifierTable'>
							<tr>
								<td>
									<label for="models">profile name: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponNameX" size="3" value="weapon1" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="models">models w/ weapon: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="10" />
								</td>
							</tr>
							<tr>
								<td/>
								<td/>
							</tr>
							<tr>
								<td>
									<label for="models">attacks: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="2" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="models">to hit: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="4" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="models">to wound: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="4" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="models">rend: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="-" />
								</td>
							</tr>
							<tr>
								<td>
									<label for="models">damage: </label>
								</td>
								<td>
									<input type="tableInput" id="weaponName" size="3" value="1" />
								</td>
							</tr>
							<tr>
								<td/>
								<td/>
							</tr>
							<tr>
								<td>
									<label for="hitmod">hit rerolls: </label>
								</td>
								<td>
									
									<select id="hitRR" type='select2'>
										<option value="mwOnHit">none</option>
										<option value="dmgOnHit">reroll 1s</option>	
										<option value="hitsOnHit">reroll failed</option>
										<option value="attacksOnHit">reroll failed (all)</option>
										<option value="attacksOnHit">reroll 6s</option>
										<option value="rendOnHit">custom</option>
									</select>
								</td>	
							</tr> 
							<tr>
								<td>
									<label for="hitmod">wound rerolls: </label>
								</td>
								<td>
									<select id="woundRR" type='select2'>
										<option value="mwOnHit">none</option>
										<option value="dmgOnHit">reroll 1s</option>
										<option value="hitsOnHit">reroll failed</option>
										<option value="attacksOnHit">reroll failed (all)</option>
										<option value="attacksOnHit">reroll 6s</option>
										<option value="rendOnHit">custom</option>
									</select>
								</td>	
							</tr>                      
							<tr type='procRow'>
								<td>
									<label for="hitmod">add proc: </label>
								</td>
								<td>
									<select id="procType" type='select2' onchange='addProc(this)'>
										<option value="none">none</option>
										<option value="mwOnHit">+MW on hit</option>
										<option value="dmgOnHit">+Damage on hit</option>
										<option value="hitsOnHit">+Hits on hit</option>
										<option value="attacksOnHit">+Attacks on hit</option>
										<option value="rendOnHit">+Rend on hit</option>
										<option value="mwOnWound">+MW on wound</option>
										<option value="dmgOnWound">+Damage on wound</option>
										<option value="attacksOnWound">+Attacks on wound</option>
										<option value="rendOnWound">+Rend on wound</option>
									</select>
								</td>
							</tr>
							
							<tr id='silentProc' style='display:none'>
								<td>
									<label id='procDescriptor' for="models">+mw on hit: </label>
								</td>
								<td type='left'>
                                    <label id='procText1'>generates</label>
									<input type="tableInputHalf" id="weaponName" size="3" value="1" />
									<label id='procText2'>attacks</label>
									<input type="tableInputHalf" id="weaponName" size="3" value="6" />
								</td>
							</tr>
						</table>
					</div>
				</td>				
			</tr>
		</table>
    </div>
        
    <button onclick="addWeapon()">Add Profile</button>
    <button onclick="removeWeapon()">Remove Profile</button>
    </br>
    </br>
	
    <script>
        function getProcLabels(procType)
        {
            let labels = ["", "mw on a"];

            if (procType.includes('+Damage'))
            {
                labels = ["","damage on a"];
            }
            else if (procType.includes('+Hits'))
            {
                labels = ["","hits on a"];
            }
            else if (procType.includes('+Rend'))
            {
                labels = ["","rend on a"];
            }
            else if (procType.includes('+Attacks'))
            {
                labels = ["","attacks on a"];
            }

            return labels;
        }

        function addProc(inWeapon)
        {
            let procType = inWeapon.options[inWeapon.selectedIndex].innerHTML;
            inWeapon.selectedIndex = 0;

            let lastRow = document.querySelector('tr[id=silentProc');

            inWeapon = inWeapon.parentNode.parentNode.parentNode;
            // let lastRow = inWeapon.rows[ inWeapon.rows.length - 1 ];
            let cloneRow = lastRow.cloneNode(true);

            console.log(cloneRow);

            cloneRow.setAttribute('style', '');

            let label0 = cloneRow.querySelector('label[id=procDescriptor]');
            let label1 = cloneRow.querySelector('label[id=procText1]');
            let label2 = cloneRow.querySelector('label[id=procText2]');
            
            label0.innerHTML = procType;

            let labels = getProcLabels(procType);
            label1.innerHTML = labels[0];
            label2.innerHTML = labels[1];

            inWeapon.appendChild(cloneRow);
        }

        function removeProc(inWeapon)
        {
            let lastRow = inWeapon.rows[ inWeapon.rows.length - 1 ];

            if (lastRow.style != "display:none")
            {
                lastRow.remove();
            }
        }

        function addWeapon()
        {
			let profileTd = document.querySelectorAll('td[type=profilesTd]')[0];
            myClone = profileTd.cloneNode(true);
            document.getElementById('kingsRow').appendChild(myClone);

            let weaponNames = document.querySelectorAll('input[id=weaponNameX]');
            weaponNames[weaponNames.length - 1].value = 'weapon'+(weaponNames.length).toString();
        }

        function removeWeapon()
        {
            let weaponNames = document.querySelectorAll('td[type=profilesTd]');

            if (weaponNames.length > 1)
            {
                weaponNames[weaponNames.length - 1].remove();
            }
        }
    </script>

	<!------------->
	<!--         -->
    <!-- MODS/RRS-->
	<!--         -->
	<!------------->
	<div id='UNITBUFFS'>
		<div><font size="4"><i>Unit-wide Buffs</i></font></div>
        <table type='modifierTable'>
            <tr>
                <td type='lower'>
                    <label for="attackmod">bonus attacks: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" />
                </td>	
            </tr>
            
            
            <tr>
                <td type='lower'>
                    <label for="attackmod">hit modifier: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" />
                </td>	
            </tr>
            
            
            <tr>
                <td type='lower'>
                    <label for="attackmod">wound modifier: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" />
                </td>	
            </tr>
            
            <tr>
                <td type='lower'>
                    <label for="hitmod">hit rerolls: </label>
                </td>
                <td>
                    
                    <select id="hitRR" type='select2'>
                        <option value="mwOnHit">none</option>
                        <option value="dmgOnHit">reroll 1s</option>	
                        <option value="hitsOnHit">reroll failed</option>
                        <option value="attacksOnHit">reroll failed (all)</option>
                        <option value="attacksOnHit">reroll 6s</option>
                        <option value="rendOnHit">custom</option>
                    </select>
                </td>	
            </tr>
            
            <tr>
                <td type='lower'>
                    <label for="hitmod">wound rerolls: </label>
                </td>
                <td>
                    <select id="woundRR" type='select2'>
                        <option value="mwOnHit">none</option>
                        <option value="dmgOnHit">reroll 1s</option>
                        <option value="hitsOnHit">reroll failed</option>
                        <option value="attacksOnHit">reroll failed (all)</option>
                        <option value="attacksOnHit">reroll 6s</option>
                        <option value="rendOnHit">custom</option>
                    </select>
                </td>	
            </tr>
            
            <tr type='procRow'>
                <td type='lower'>
                    <label for="hitmod">procs: </label>
                </td>
                <td>
                    <select id="procType" type='select2' onChange='addProc(this)'>
                        <option value="none">none</option>
                        <option value="mwOnHit">+MW on hit</option>
                        <option value="dmgOnHit">+Damage on hit</option>
                        <option value="hitsOnHit">+Hits on hit</option>
                        <option value="attacksOnHit">+Attacks on hit</option>
                        <option value="rendOnHit">+Rend on hit</option>
                        <option value="mwOnWound">+MW on wound</option>
                        <option value="dmgOnWound">+Damage on wound</option>
                        <option value="attacksOnWound">+Attacks on wound</option>
                        <option value="rendOnWound">+Rend on wound</option>
                    </select>
                </td>
            </tr>
            							
            <tr style='display:none'>
                    <td>
                        <label for="models">+mw on hit: </label>
                    </td>
                    <td type='left'>
                        <input type="tableInputHalf" id="weaponName" size="3" value="6+" />
                        <label>make</label>
                        <input type="tableInputHalf" id="weaponName" size="3" value="d6" />
                        <label>attacks</label>
                    </td>
                </tr>
        </table>
		
		</br>
		
    </div>  
	
	<!------------->
	<!--         -->
    <!-- TARGET  -->
	<!--         -->
	<!------------->
	<div id='TARGET'>
        <div><font size="4"><i>Target Profile</i></font></div>
        <table type='modifierTable'>
            <tr>
                <td type='lower'>
                    <label for="attackmod">save: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" value="4"/>
                </td>	
            </tr>
            
            <tr type='procRow' type='lower'>
                <td>
                    <label for="hitmod">ward save: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" />
                </td>	
            </tr>
			
			<td/>
			<td/>
			
            <tr>
                <td type='lower'>
                    <label for="attackmod">save modifier: </label>
                </td>
                <td>
                    <input type="tableInput" id="attackmod" size="2" />
                </td>	
            </tr>
			
            <tr>
                <td type='lower'>
                    <label for="hitmod">save rerolls: </label>
                </td>
                <td>
                    <select id="hitRR" type='select2'>
                        <option value="mwOnHit">none</option>
                        <option value="dmgOnHit">reroll 1s</option>	
                        <option value="hitsOnHit">reroll failed</option>
                        <option value="attacksOnHit">reroll failed (all)</option>
                        <option value="attacksOnHit">reroll 6s</option>
                        <option value="rendOnHit">custom</option>
                    </select>
                </td>	
            </tr>
			
            <tr>
                <td type='lower'>
                    <label for="hitmod">ward rerolls: </label>
                </td>
                <td>
                    <select id="hitRR" type='select2'>
                        <option value="mwOnHit">none</option>
                        <option value="dmgOnHit">reroll 1s</option>	
                        <option value="hitsOnHit">reroll failed</option>
                        <option value="attacksOnHit">reroll failed (all)</option>
                        <option value="attacksOnHit">reroll 6s</option>
                        <option value="rendOnHit">custom</option>
                    </select>
                </td>	
            </tr>
        </table>
    </div>
	
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
    <!-- Help -->
	
    <br />
    <br />
    <br />
    <br />
	
    <div>
        <i><b>Notes:</b><br />
        - In the reroll (RR) boxes, you have to enter a list of the numbers you wish to reroll. E.g. "1, 2, 3" or "1 2 3" to reroll failed hits for 4+. or "1" for rerolling just 1s.<br />
        - To compare two sets of stats, set your first stats, press "Sigmulate", then set your second set of stats and press "Compare".<br />

        - For things like MW on hits, the roll is the number required to do the mortal wound, the value is the amount of mortal wounds. E.g. 6s to hit do a MW: Roll=6, Value=1. <br />
        - Output is the percentage chance of doing AT LEAST x amount of damage.<br />

        e.g. 03 <span style="color: blue">||||||</span><span style="color: red">|||</span> 50% 70% means there is a 50% chance of blue doing 3 or more wounds, and a 70% chance of red doing 3 or more wounds.<br /></i>
    </div>
    <br />
    <br />

    <!-- buttons -->
    <button onclick="onSigmulate()" style="font-size : 12px; width: 80px; height: 40px;">Sigmulate</button>
    <button onclick="onCompare()" style="font-size : 12px; width: 80px; height: 40px;">Compare</button>
    <button onclick="onSum()" style="font-size : 12px; width: 80px; height: 40px;">Add To Last</button>
    <button onclick="onClear()" style="font-size : 12px; width: 80px; height: 40px;">Clear Stack</button>

    <!-- output -->
    <font size="3">
        <p id="confidenceEstimate"></p>
        <p id="scriptOutput"></p>
    </font>

    <!-- scripts -->
    <script src="sigmulator.js"></script>
    <script type="text/javascript">
        let comparatives = [];
        function onCompare()
        {
            onSigmulate(compare=true);
        }

        function onSum()
        {
            onSigmulate(compare=false, sum=true);
        }
		
        function onClear()
        {
			document.getElementById("scriptOutput").innerHTML = "";
            comparatives = [];
        }
		
        function diceParseInt(s)
        {
            s = s.toLowerCase();
						var regEx = /(\d*)d(\d+)(\+(\d+))*/;
						var match = regEx.exec(s);

						int prefix = parseInt(match[1])
						int suffix = parseInt(match[2])
						int addition = parseInt(match[4])

		

            if (s.includes("5d3")) return -53;
            else if (s.includes("4d3")) return -43;
            else if (s.includes("3d3")) return -33;
            else if (s.includes("2d3")) return -23;
            else if (s.includes("4d6")) return -46;
            else if (s.includes("3d6")) return -36;
            else if (s.includes("2d6")) return -26;
            else if (s.includes("d6")) return -6;
            else if (s.includes("d3")) return -3;

            return parseInt(s);
        }

        function onSigmulate(compare = false, sum = false) {
            let a = diceParseInt(document.getElementById('attacks').value);
            let h = parseInt(document.getElementById('tohit').value);
            let w = parseInt(document.getElementById('towound').value);
            let r = parseInt(document.getElementById('rend').value);
            let d = diceParseInt(document.getElementById('damage').value);
            let s = parseInt(document.getElementById('tosave').value);
            let am = parseInt(document.getElementById('attackmod').value);
            let hm = parseInt(document.getElementById('hitmod').value);
            let wm = parseInt(document.getElementById('woundmod').value);
            let sm = parseInt(document.getElementById('savemod').value);
            let hrr = document.getElementById('hrr').value;
            let wrr = document.getElementById('wrr').value;
            let srr = document.getElementById('srr').value;
            let ward = parseInt(document.getElementById('ward').value);
            let models = parseInt(document.getElementById('models').value);
            let mwOnly = document.getElementById('mwOnly').checked;

            let procType = document.getElementById('procType').value;
            let procRoll = parseInt(document.getElementById('procRoll').value);
            let procValue = diceParseInt(document.getElementById('procValue').value);
            
            let attack = newAttack(a+nanIsZero(am), h, w, r, d, s, hm, wm, sm, hrr, wrr, srr, ward, mwOnly, models, procType, procRoll, procValue);

            if (compare)
                document.getElementById("scriptOutput").innerHTML = actuallyCompare(attack, comparatives[comparatives.length - 1]);
			else if (sum)
                document.getElementById("scriptOutput").innerHTML = getMultiSumDamageString([attack].concat(comparatives));
            else {
                document.getElementById("scriptOutput").innerHTML = fancyPrint(atLeast(attack));
                comparatives = [];
            }
			
			// confidence estimate
			let confidence = 70;
			var lines = document.getElementById("scriptOutput").innerHTML.split('%<br>');
			for (var i = lines.length - 1; i >= 0; i--)
			{
				var dmg = parseInt(lines[i].charAt(0)+lines[i].charAt(1));
				var chance = parseInt(lines[i].slice(-2));
				
				if (chance >= confidence)
				{
					document.getElementById("confidenceEstimate").innerHTML = "70% chance of at least <span style=\"color: red\"><font size=\"5\">"+dmg+"</span></font> wound(s).";
					break;
				}
				document.getElementById("confidenceEstimate").innerHTML = "";
			}
			

            comparatives.push(attack);
        }
    </script>

    <footer>
        <font size="2">
            <p>Copyright &copy; James Ganis</p>
        </font>
    </footer>

    <script>
        (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-98404928-1', 'auto');
        ga('send', 'pageview'); 
    </script>
</body>

</html>
